<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>Git Mirror Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Arial; margin: 0; padding: 24px; background: #f8f9fa; }
    .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1 { font-size: 24px; margin: 0 0 20px 0; color: #212529; }
    label { display: block; margin-bottom: 6px; font-weight: 500; color: #495057; }
    input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; }
    .controls { display: flex; gap: 10px; margin-top: 12px; align-items: center; flex-wrap: wrap; }
    button { padding: 10px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
    button:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #run { background: #0d6efd; color: #fff; }
    #runStream { background: #198754; color: #fff; }
    #pick { background: #6c757d; color: #fff; }
    #stop { background: #dc3545; color: #fff; }
    .status { margin-left: 10px; padding: 6px 12px; border-radius: 4px; font-size: 14px; font-weight: 500; }
    .status.running { background: #cfe2ff; color: #084298; }
    .status.done { background: #d1e7dd; color: #0f5132; }
    .status.error { background: #f8d7da; color: #842029; }
    
    .progress-section { margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 6px; display: none; }
    .progress-section.active { display: block; }
    .progress-bar-container { width: 100%; height: 24px; background: #e9ecef; border-radius: 12px; overflow: hidden; margin: 10px 0; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, #0d6efd, #0a58ca); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 12px; font-weight: 600; }
    .stats { display: flex; gap: 20px; margin-top: 12px; flex-wrap: wrap; }
    .stat-item { display: flex; align-items: center; gap: 8px; }
    .stat-label { font-size: 14px; color: #6c757d; }
    .stat-value { font-size: 20px; font-weight: 700; }
    .stat-value.success { color: #198754; }
    .stat-value.failed { color: #dc3545; }
    .stat-value.skipped { color: #6c757d; }
    .stat-value.total { color: #0d6efd; }
    
    .list { margin-top: 20px; }
    .repo { border: 1px solid #dee2e6; padding: 12px; margin-bottom: 10px; border-radius: 6px; background: #fff; transition: all 0.2s; }
    .repo:hover { box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .repo-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .repo .path { font-weight: 600; font-size: 14px; color: #212529; flex: 1; word-break: break-all; }
    .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; color: #fff; font-weight: 600; white-space: nowrap; }
    .badge.pull { background: #0d6efd; animation: pulse 1.5s infinite; }
    .badge.success { background: #198754; }
    .badge.failed { background: #dc3545; }
    .badge.skipped { background: #6c757d; }
    .badge.cancelled { background: #ffc107; color: #000; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    
    .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin-top: 8px; max-height: 200px; overflow-y: auto; border-radius: 4px; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; line-height: 1.5; }
    .log-line { margin: 2px 0; }
    .log-line.stderr { color: #dc3545; }
    .log::-webkit-scrollbar { width: 8px; }
    .log::-webkit-scrollbar-track { background: #e9ecef; }
    .log::-webkit-scrollbar-thumb { background: #adb5bd; border-radius: 4px; }
    
    .summary { margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: #fff; display: none; }
    .summary.active { display: block; }
    .summary-title { font-size: 18px; font-weight: 700; margin-bottom: 12px; }
    .summary-content { display: flex; gap: 30px; flex-wrap: wrap; }
    .summary-item { display: flex; flex-direction: column; }
    .summary-item-label { font-size: 12px; opacity: 0.9; margin-bottom: 4px; }
    .summary-item-value { font-size: 28px; font-weight: 700; }
    .time-info { margin-top: 12px; font-size: 13px; opacity: 0.9; }
    
    pre { background: #f5f5f5; padding: 12px; white-space: pre-wrap; border: 1px solid #ddd; margin-top: 16px; border-radius: 4px; display: none; }
  </style>
  </head>
<body>
  <div class="container">
    <h1>ğŸ”„ Git Mirror Manager</h1>
    <label for="dir">ç›®æ ‡æ ¹ç›®å½•è·¯å¾„</label>
    <input id="dir" type="text" placeholder="ä¾‹å¦‚ï¼šD:\\code\\repos" />
    <div class="controls">
      <button id="run">æ‰§è¡Œæ‹‰å–</button>
      <button id="runStream">æµå¼æ‹‰å–</button>
      <button id="pick">é€‰æ‹©ç›®å½•</button>
      <button id="stop" disabled>åœæ­¢</button>
      <span id="status" class="status"></span>
    </div>
    
    <div id="progress" class="progress-section">
      <div class="progress-bar-container">
        <div id="progressBar" class="progress-bar" style="width: 0%">0%</div>
      </div>
      <div class="stats">
        <div class="stat-item">
          <span class="stat-label">æ€»è®¡:</span>
          <span class="stat-value total" id="statTotal">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">æˆåŠŸ:</span>
          <span class="stat-value success" id="statSuccess">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">å¤±è´¥:</span>
          <span class="stat-value failed" id="statFailed">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">è·³è¿‡:</span>
          <span class="stat-value skipped" id="statSkipped">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">è¿›è¡Œä¸­:</span>
          <span class="stat-value total" id="statProcessing">0</span>
        </div>
      </div>
    </div>
    
    <pre id="output" aria-live="polite"></pre>
    <div id="list" class="list"></div>
    
    <div id="summary" class="summary">
      <div class="summary-title">âœ… ä»»åŠ¡å®Œæˆ</div>
      <div class="summary-content">
        <div class="summary-item">
          <div class="summary-item-label">æˆåŠŸ</div>
          <div class="summary-item-value" id="summarySuccess">0</div>
        </div>
        <div class="summary-item">
          <div class="summary-item-label">å¤±è´¥</div>
          <div class="summary-item-value" id="summaryFailed">0</div>
        </div>
        <div class="summary-item">
          <div class="summary-item-label">è·³è¿‡</div>
          <div class="summary-item-value" id="summarySkipped">0</div>
        </div>
        <div class="summary-item">
          <div class="summary-item-label">æ€»è®¡</div>
          <div class="summary-item-value" id="summaryTotal">0</div>
        </div>
      </div>
      <div class="time-info" id="timeInfo"></div>
    </div>
  </div>
<script>
  const $dir = document.getElementById('dir');
  const $run = document.getElementById('run');
  const $runStream = document.getElementById('runStream');
  const $stop = document.getElementById('stop');
  const $pick = document.getElementById('pick');
  const $out = document.getElementById('output');
  const $status = document.getElementById('status');
  const $list = document.getElementById('list');
  const $summary = document.getElementById('summary');
  const $progress = document.getElementById('progress');
  const $progressBar = document.getElementById('progressBar');
  const $statTotal = document.getElementById('statTotal');
  const $statSuccess = document.getElementById('statSuccess');
  const $statFailed = document.getElementById('statFailed');
  const $statSkipped = document.getElementById('statSkipped');
  const $statProcessing = document.getElementById('statProcessing');
  const $summarySuccess = document.getElementById('summarySuccess');
  const $summaryFailed = document.getElementById('summaryFailed');
  const $summarySkipped = document.getElementById('summarySkipped');
  const $summaryTotal = document.getElementById('summaryTotal');
  const $timeInfo = document.getElementById('timeInfo');
  
  let startTime = null;
  let stats = { total: 0, success: 0, failed: 0, skipped: 0, processing: 0 };

  async function runFetch() {
    const directoryPath = $dir.value.trim();
    if (!directoryPath) {
      alert('è¯·è¾“å…¥ç›®æ ‡æ ¹ç›®å½•è·¯å¾„');
      return;
    }
    $status.textContent = 'è¿è¡Œä¸­...';
    $status.className = 'status running';
    $out.style.display = 'block';
    $out.textContent = '';
    try {
      const resp = await fetch('/fetch', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ directoryPath })
      });
      const text = await resp.text();
      $out.textContent = text;
      $status.textContent = resp.ok ? 'å®Œæˆ' : 'å¤±è´¥';
      $status.className = resp.ok ? 'status done' : 'status error';
    } catch (e) {
      $out.textContent = e.message || String(e);
      $status.textContent = 'å¤±è´¥';
      $status.className = 'status error';
    }
  }

  $run.addEventListener('click', runFetch);

  function createRepoEl(path) {
    const wrap = document.createElement('div');
    wrap.className = 'repo';
    const header = document.createElement('div');
    header.className = 'repo-header';
    const pathEl = document.createElement('span');
    pathEl.textContent = path;
    pathEl.className = 'path';
    const badge = document.createElement('span');
    badge.className = 'badge pull';
    badge.textContent = 'æ‹‰å–ä¸­';
    header.appendChild(pathEl);
    header.appendChild(badge);
    const log = document.createElement('div');
    log.className = 'log';
    wrap.appendChild(header);
    wrap.appendChild(log);
    $list.appendChild(wrap);
    return { wrap, badge, log };
  }

  function setBadge(badge, status){
    badge.className = 'badge ' + status;
    const map = { pull: 'æ‹‰å–ä¸­', success: 'æˆåŠŸ', failed: 'å¤±è´¥', skipped: 'è·³è¿‡', cancelled: 'å·²å–æ¶ˆ' };
    badge.textContent = map[status] || status;
  }

  function appendLine(logEl, text, isError = false){
    const div = document.createElement('div');
    div.className = 'log-line' + (isError ? ' stderr' : '');
    div.textContent = text;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }

  function updateStats() {
    $statTotal.textContent = stats.total;
    $statSuccess.textContent = stats.success;
    $statFailed.textContent = stats.failed;
    $statSkipped.textContent = stats.skipped;
    $statProcessing.textContent = stats.processing;
    
    const completed = stats.success + stats.failed + stats.skipped;
    if (stats.total > 0) {
      const percent = Math.round((completed / stats.total) * 100);
      $progressBar.style.width = percent + '%';
      $progressBar.textContent = percent + '%';
    }
  }

  function resetUI(){
    $list.innerHTML = '';
    $summary.classList.remove('active');
    $progress.classList.remove('active');
    $out.style.display = 'none';
    $out.textContent = '';
    stats = { total: 0, success: 0, failed: 0, skipped: 0, processing: 0 };
    updateStats();
    startTime = null;
  }

  function runStream(){
    const directoryPath = $dir.value.trim();
    if (!directoryPath) { alert('è¯·è¾“å…¥ç›®æ ‡æ ¹ç›®å½•è·¯å¾„'); return; }
    resetUI();
    startTime = Date.now();
    $status.textContent = 'æµå¼è¿è¡Œä¸­...';
    $status.className = 'status running';
    $progress.classList.add('active');
    $run.disabled = true; $runStream.disabled = true; $stop.disabled = false;
    const url = '/fetch-stream?dir=' + encodeURIComponent(directoryPath);
    window.__es && window.__es.close();
    const es = new EventSource(url);
    window.__es = es;
    const repoMap = new Map();

    es.addEventListener('start', e => {
      const data = JSON.parse(e.data);
      console.log('å¼€å§‹æ‹‰å–ï¼š' + (data.dir || ''));
    });
    
    es.addEventListener('repo-start', e => {
      const { path } = JSON.parse(e.data);
      const el = createRepoEl(path);
      repoMap.set(path, el);
      stats.total++;
      stats.processing++;
      updateStats();
    });
    
    es.addEventListener('repo-log', e => {
      const { path, line, stream } = JSON.parse(e.data);
      const el = repoMap.get(path);
      if (!el) return;
      appendLine(el.log, line, stream === 'stderr');
    });
    
    es.addEventListener('repo-status', e => {
      const { path, status } = JSON.parse(e.data);
      const el = repoMap.get(path);
      if (!el) return;
      setBadge(el.badge, status);
      
      stats.processing--;
      if (status === 'success') stats.success++;
      else if (status === 'failed') stats.failed++;
      else if (status === 'skipped' || status === 'cancelled') stats.skipped++;
      updateStats();
    });
    
    es.addEventListener('summary', e => {
      const { success, failed, skipped } = JSON.parse(e.data);
      const total = success + failed + skipped;
      const elapsed = startTime ? ((Date.now() - startTime) / 1000).toFixed(1) : '0';
      
      $summarySuccess.textContent = success;
      $summaryFailed.textContent = failed;
      $summarySkipped.textContent = skipped;
      $summaryTotal.textContent = total;
      $timeInfo.textContent = `â±ï¸ è€—æ—¶: ${elapsed}ç§’ | ğŸ“ ç›®å½•: ${directoryPath}`;
      $summary.classList.add('active');
    });
    
    es.addEventListener('error', e => {
      try { 
        const data = JSON.parse(e.data); 
        console.error('é”™è¯¯ï¼š' + (data.message || ''));
      } catch {}
    });
    
    es.addEventListener('done', () => {
      $status.textContent = 'âœ… å®Œæˆ';
      $status.className = 'status done';
      es.close();
      $run.disabled = false; $runStream.disabled = false; $stop.disabled = true;
    });
    
    es.addEventListener('cancelled', () => {
      $status.textContent = 'âš ï¸ å·²åœæ­¢';
      $status.className = 'status error';
      es.close();
      $run.disabled = false; $runStream.disabled = false; $stop.disabled = true;
    });

    es.onerror = (err) => {
      $status.textContent = 'âŒ å¤±è´¥';
      $status.className = 'status error';
      $run.disabled = false; $runStream.disabled = false; $stop.disabled = true;
    };
  }

  $runStream.addEventListener('click', runStream);

  async function pickFolder(){
    try {
      const resp = await fetch('/pick-folder');
      const data = await resp.json();
      if (data && data.directoryPath) {
        $dir.value = data.directoryPath;
      } else {
        alert('æœªé€‰æ‹©ä»»ä½•ç›®å½•');
      }
    } catch (e) {
      alert('é€‰æ‹©ç›®å½•å¤±è´¥ï¼š' + (e.message || e));
    }
  }
  $pick.addEventListener('click', pickFolder);

  async function stop(){
    try {
      $status.textContent = 'åœæ­¢ä¸­...';
      await fetch('/cancel', { method: 'POST' });
    } catch (e) {
      console.error(e);
    }
  }
  $stop.addEventListener('click', stop);
</script>
</body>
</html>